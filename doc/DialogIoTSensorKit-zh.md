# Dialog IoT Sensor Kit

## 概述

Dialog IoT Sensor Kit是Dialog Semiconductor推出的传感器应用开发套件, 其中包含一个惯性测量传感器（加速度和角速度），一个磁力计和一个环境传感器（温度、温度、气压）。在[官网链接](http://www.dialog-semiconductor.com/iotsensor)中有更加详细的介绍。  
在Evothings项目中有一个关于此设备的[开源APP](https://evothings.com/dialog-iot-sensor-starter-guide/)，用JavaScript写成，我们在一开始接触这款设备时参考了这个APP。  

## 数据交互

服务UUID: 2ea78970-7d44-44bb-b097-26183f402400，以下讨论的所有特征都是这个服务之下的。

1. 读设备信息

    读特征【2ea78970-7d44-44bb-b097-26183f402408】，返回信息中包含传感器可用性，以及固件版本号：

    * Bytes 0~6: 每个字节表示一种传感器是否可用 (1: 可用, 0: 不可用)

        * Byte0 - 加速度计  
        * Byte1 - 陀螺仪  
        * Byte2 - 磁力计  
        * Byte3 - 气压计  
        * Byte4 - 温度计  
        * Byte5 - 湿度计  
        * Byte6 - SFL（传感器融合，如果这个可用，那么加速度计、陀螺仪、磁力计都可用，即使它们对应的字节是0）

    * Bytes 7~end: 固件版本号，字符串

1. 控制命令

    向特征【2ea78970-7d44-44bb-b097-26183f402409】写入一个字节，即可执行相应的控制命令。打开特征【2ea78970-7d44-44bb-b097-26183f40240A】的通知，接收控制命令的回应。

    * 0 - 停止传感器（所有传感器的总开关）
    * 1 - 开启传感器（所有传感器的总开关）
    * 6 - 查询传感器运行状态（回应：0 - 停止，1 - 开启）
    * 11(0x0B) - 查询设置信息
    
        在回应数据中：
        
      * Byte3表示加速度计的取值范围：  
        * 3 - 2g  
        * 5 - 4g  
        * 8 - 8g  
        * 12 - 16g  
        
      * Byte5表示陀螺仪的取值范围：  
        * 0 - 2000  
        * 1 - 1000  
        * 2 - 500  
        * 3 - 250  
        * 4 - 125  

1. 接收传感器数据

    为接收传感器数据，需要确保传感器开启——写控制命令1打开总开关，然后使能传感器对应特征的通知。  
    在接收到的数据当中，数值是从字节3开始的，每个数值包含2或4个字节（低字节在前），有的传感器包含多个数值，以下用维度表示（比如三轴加速度计包含X、Y、Z三个方向的数值，维度即为3）：  

    * 加速度计 ACCELEROMETER
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402401
        * 字节数: 2
        * 维度: 3
        * 单位: g

        返回值应当根据加速度计的取值范围除一个系数：

        取值范围|系数
        -----|-----
        2g|16384
        4g|8192
        8g|4096
        16g|2048

    * 陀螺仪 GYROSCOPE
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402402
        * 字节数: 2
        * 维度: 3
        * 单位:  deg/s

        返回值应当根据陀螺仪的取值范围除一个系数：

        取值范围|系数
        -----|-----
        2000|16.4
        1000|32.8
        500|65.6
        250|131.2
        125|262.4

    * 磁力计 MAGNETOMETER
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402403
        * 字节数: 2
        * 维度: 3
        * 单位: uT

    * 气压计 BAROMETER
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402404
        * 字节数: 4
        * 维度: 1
        * 单位: Pa

    * 湿度 HUMIDITY
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402405
        * 字节数: 4
        * 维度: 1
        * 单位: %（将返回值除以1024）

    * 温度 TEMPERATURE
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402406
        * 字节数: 4
        * 维度: 1
        * 单位: °C（将返回值除以100）

    * 传感器融合 (Sensor Fusion)
        * 特征UUID: 2ea78970-7d44-44bb-b097-26183f402407
        * 字节数: 2
        * 维度: 4（顺序为w、x、y、z）
        
        将返回值除以32768，介于[-1,1]之间。

## 数据解读

1. 加速度计

    下图展示了X、Y、Z相对于设备的方向。
    将设备平放在桌面上，有LED的一侧朝上，Z轴正方向所指与重力加度一致（即此时加速度Z方向的分量为1）
    如果将设备竖起来放，就像一个小写的字母d，那么加速度的x分量为1。  
    ![Image not displayed](DialogIoTSensorKit-Accelerometer.jpg "设备x, y, z轴对应的方向")

1. 陀螺仪

    陀螺仪用于测量设备旋转的速度。
    看向LED所在的一侧，这正是z轴的方向，现在当设备按顺时针方向旋转时，陀螺仪数值的z分量将为负值。
    陀螺仪数值的单位是度/秒，即每秒旋转多少度。
    ![Image not displayed](DialogIoTSensorKit-Gyroscope.jpg "设备的旋转速度")

1. 传感器融合

    传感器融合指设备用内置算法，根据加速度计、陀螺仪和磁力计的数据计算设备的实时姿态，用四元数 w + xi + yj +zk 表示。关于四元数的详细解释，请参考：[四元數與旋轉](https://openhome.cc/Gossip/ComputerGraphics/QuaternionsRotate.htm)。